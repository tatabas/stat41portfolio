---
title: "Project 3"
author: "Tolga Atabas"
date: "1/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen=999)

library(tidymodels)
library(tidyverse)
library(dplyr)
library(gt)
library(glue)

data = read_csv("data.csv")
```

## Sensitivity and Specificity

This dataset is from Spotify and lists different songs from the 1920's to present day, along with some custom characteristics like the danceability of the song, the energy, acousticness, and valence (happiness conveyed). There is also a metric that measures the popularity of the song. This model will take all of these variables and aim to predict explicitness in a song. Of course, since it is difficult to compare present day to a century ago, the data will be adjusted to only show data from the 1970s to present day.

The model will take the inputs of the various danceability, valence, energy, acousticness, speechiness, liveness, loudness, and popularity variables and apply a logistic regression model to predict explicitness. Since explicitness is marked by a binomial 1 or 0, logistic regression is the model to choose. Logistic regression takes the inputs of 0 to 1 and creates a model that measures likelihood of the event happening. In this case, the  liklihood that the song will be explicit.

The shiny app has features to select the cut-off point and view the impact this has on the sensitivity and specificity. These two measures are ways that the model is evaluated. Sensitivity measures the rate at which the model correctly identifies positives. In context, this is the rate at which explicit songs are identified as explicit. 
$$Sensitivity = \frac{n_{\text{true postivie}}}{n_{\text{true postivie}} + n_{\text{false negative}}}$$ 


On the other hand, specificity is the rate at which the model correctly identifies negatives. In this context, it is the rate that the non-explicit songs are identified as explicit.
$$Specificity = \frac{n_{\text{true negaitve}}}{n_{\text{true negative}} + n_{\text{false positive.}}}$$ 

These terms come up a lot especially in the field of blood/disease testing. Sensitivity and specificity are important in learning more about the specific model or test and how well it works. Also, the specificity and sensitivity are adjustable by using a threshold. Depending on any specific wants for a model, the need for a specific sensitivity value may change. For example, in disease testings with COVID-19 or TB, it is preferred to have a high sensitivity since it is necessary to quarantine or treat disease-carriers. However, this comes with a trade-off, the specificity. So, by increasing overall positive test results by increasing sensitivity, the model is also increasing the occurrence of false positive scores, and thereby decreasing the specificity. 

This shiny app is meant to give a deeper understanding of these concepts by allowing the user to choose a given threshold and view the sensitivity and specificity values that this would create in the model. Additionally, below the table, there is an ROC plot that shows the user where they are right now in relation to the other possibilities of sensitivity and specificity. It also gives a sense as to how the specificity or sensitivity can change with changing values.

 

```{r model}
library(ROCR)
library(ggthemes)

data <- data %>%
  filter(year >= 1970)

mod <- glm(explicit ~ danceability + valence + energy + acousticness + speechiness + liveness + loudness + popularity, data = data, family = "binomial")

pred = predict(mod,data,type="response")
pred = prediction(pred, data$explicit)

sensitivity = pred@tp[[1]] / (pred@tp[[1]] + pred@fn[[1]])
specificity = pred@tn[[1]] / (pred@tn[[1]] + pred@fp[[1]])
total_expl = as.numeric(pred@n.pos[[1]])
total_non_expl = as.numeric(pred@n.neg[[1]])

roc <- data.frame(sensitivity, specificity, pred@cutoffs, 
                  pred@tn, pred@tp, pred@fn, pred@fp)
colnames(roc) = c("sensitivity", "specificity", "cut", "tn", "tp", "fp", "fn")

non_expl <- c(1,2,3, "Sensitivity")
      expl <- c(1,2,3, "Specificity")
      names <- c("Pred Non Expl", "Pred Expl"," "," ")
      
      conf_data <- data.frame(names, non_expl, expl)
      
      
```

```{r shiny}
library(shiny)
library(formattable)
library(plotly)


# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Sensitivity and Specificity"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput(inputId = "cutoff",
                        label = "Cut Off: ",
                        min = 0,
                        max = 1,
                        value = 0.19)
        ),
        
        # Show a plot of the generated distribution
        mainPanel(
            gt_output(outputId = "mytable"),
            br(),
            br(),
            #plotlyOutput(outputId = "plot"),
            plotOutput(outputId = "plot"),
        )
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {
    tabData <- reactive({
      req(input$cutoff)
      roc %>%
        filter(round(cut,2) == input$cutoff)
    })

    output$mytable = render_gt({
      #tn, tp, fn, fp
      tabs = tabData()[2,] %>%
        select(c(-cut))
      
      non_expl <- c(round(tabs$tn,0),round(tabs$fp,0),round(tabs$sensitivity,2), "Sensitivity")
      expl <- c(round(tabs$tp,0),round(tabs$fn,0),round(tabs$specificity,2), "Specificity")
      names <- c("Pred Non Expl", "Pred Expl"," "," ")
      
      conf_data <- data.frame(names, non_expl, expl)
      
      #tabs = matrix(c(round(tabs$tn,0),round(tabs$fp,0),round(tabs$sensitivity,2),
                      #round(tabs$tp,0),round(tabs$fn,0),round(tabs$specificity,2)), 
                   # ncol = 2, byrow = FALSE)
      #tabs = as.tibble(tabs)
      
      gt_tbl <- gt(data = conf_data) %>%
        tab_header(
          title = "Confusion Matrix"
        ) %>%
        tab_spanner(
          label = "",
          columns = vars(names,non_expl,expl)
        ) %>%
        cols_label(
          names = "",
          non_expl = "Not Explicit",
          expl = "Explicit"
        ) 
      
      gt_tbl
      
    })
    
    output$plot = renderPlot({ #renderplotly
      
      point = tabData()[2,]
      
      p3 <- ggplot(data = roc, 
                   aes(x = specificity, y = sensitivity)) +
        geom_line(size = 2, color = "#31485E") + #aes(text = paste("Specificity:",specificity,
                                         #"\nSensitivity:",sensitivity,
                                         #"\nCut-off:",cut))
        geom_point(data = point, aes(x = specificity, y = sensitivity), size = 5,
                   color = "black") +
        annotate("text",x = point$specificity+.05, y = point$sensitivity+.05, 
                 label = "You are Here") +
        labs(title = "ROC curve for the explicit music prediction model",
             x = "Specificity",
             y = "Sensitivity") +
        theme_tufte() +
        xlim(0,1.1)
      #ggplotly(p3,tooltip = "text")
      p3
    })
    
}
# Run the application 
shinyApp(ui, server)
```


